<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>TDEE & Theo d√µi calo h√†ng ng√†y</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <!-- B∆∞·ªõc 1: Th√™m th∆∞ vi·ªán marked v√†o file HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div>
      <h1>TDEE & Theo d√µi calo</h1>
      <p class="subtitle">T√≠nh TDEE, ƒë·∫∑t m·ª•c ti√™u theo ch·∫ø ƒë·ªô luy·ªán t·∫≠p & theo d√µi m√≥n ƒÉn m·ªói ng√†y</p>
    </div>
    <div class="header-actions">
      <button id="exportCsvBtn" class="btn btn-outline secondary small">Xu·∫•t file CSV</button>
      <button id="resetAllBtn" class="btn btn-outline danger small">Reset to√†n b·ªô</button>
    </div>
  </header>

  <main class="layout">
    <!-- Kh·ªëi 1: Th√¥ng tin c√° nh√¢n & TDEE -->
    <section class="card" id="tdeeCard">
      <h2>
        <span>1. Th√¥ng tin &amp; TDEE</span>
        <button class="btn btn-outline small collapse-btn" data-target-id="tdeeContent"><span class="arrow-icon"></span></button>
      </h2>
      <div id="tdeeContent" class="collapsible-content">
        <form id="tdeeForm" class="form-grid">
          <div class="form-group">
            <label>Gi·ªõi t√≠nh</label>
            <div class="segmented">
              <button type="button" data-gender="male" class="segmented-btn active">Nam</button>
              <button type="button" data-gender="female" class="segmented-btn">N·ªØ</button>
            </div>
            <input type="hidden" id="gender" value="male" />
          </div>

          <div class="form-group">
            <label for="age">Tu·ªïi</label>
            <input type="number" id="age" min="10" max="80" value="25" />
          </div>

          <div class="form-group">
            <label for="height">Chi·ªÅu cao (cm)</label>
            <input type="number" id="height" min="130" max="220" value="170" />
          </div>

          <div class="form-group">
            <label for="weight">C√¢n n·∫∑ng (kg)</label>
            <input type="number" id="weight" min="35" max="200" step="0.1" value="65" />
          </div>

          <div class="form-group">
            <label for="activity">M·ª©c ƒë·ªô v·∫≠n ƒë·ªông</label>
            <select id="activity">
              <option value="1.2">√çt v·∫≠n ƒë·ªông (ng·ªìi nhi·ªÅu)</option>
              <option value="1.375">Nh·∫π (1‚Äì3 bu·ªïi/tu·∫ßn)</option>
              <option value="1.55">V·ª´a (3‚Äì5 bu·ªïi/tu·∫ßn)</option>
              <option value="1.725">Nhi·ªÅu (6‚Äì7 bu·ªïi/tu·∫ßn)</option>
              <option value="1.9">R·∫•t nhi·ªÅu (lao ƒë·ªông n·∫∑ng)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="trainingMode">Ch·∫ø ƒë·ªô luy·ªán t·∫≠p / m·ª•c ti√™u</label>
            <select id="trainingMode">
              <option value="recomp">TƒÉng c∆° gi·∫£m m·ª° (recomp)</option>
              <option value="fat_loss">Gi·∫£m m·ª°</option>
              <option value="weight_loss">Gi·∫£m c√¢n m·∫°nh</option>
              <option value="muscle_gain">TƒÉng c∆°</option>
              <option value="weight_gain">TƒÉng c√¢n</option>
              <option value="high_protein_low_carb">High Protein - Low Carb (T·∫≠p t·∫°)</option>
              <option value="custom" selected>T·ª± ch·ªânh th√¢m h·ª•t / th·∫∑ng d∆∞</option>
            </select>
            <p class="hint">Ch·ªçn ch·∫ø ƒë·ªô ƒë·ªÉ t·ª± g·ª£i √Ω th√¢m h·ª•t / th·∫∑ng d∆∞ calo, ho·∫∑c ch·ªçn "T·ª± ch·ªânh" ƒë·ªÉ nh·∫≠p tay.</p>
          </div>

          <div class="form-group">
            <label for="goal">M·ª•c ti√™u calo m·ªói ng√†y</label>
            <select id="goal">
              <option value="250">Th·∫∑ng d∆∞ nh·∫π +250 kcal/ng√†y</option>
              <option value="300">Th·∫∑ng d∆∞ +300 kcal/ng√†y</option>
              <option value="500">Th·∫∑ng d∆∞ +500 kcal/ng√†y</option>
              <option value="-250">Th√¢m h·ª•t nh·∫π -250 kcal/ng√†y</option>
              <option value="-500" selected>-500 kcal/ng√†y</option>
              <option value="-750">-750 kcal/ng√†y</option>
              <option value="-1000">-1000 kcal/ng√†y</option>
            </select>
            <p class="hint">Gi√° tr·ªã n√†y s·∫Ω c·ªông/tr·ª´ tr·ª±c ti·∫øp v√†o TDEE ƒë·ªÉ ra calo m·ª•c ti√™u.</p>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn primary">T√≠nh TDEE</button>
          </div>
        </form>

        <div id="tdeeResult" class="tdee-result">
          <div class="result-item">
            <span>TDEE (duy tr√¨):</span>
            <strong id="tdeeValue">- kcal</strong>
          </div>
          <div class="result-item">
            <span>Calo m·ª•c ti√™u (ƒë√£ √°p d·ª•ng ch·∫ø ƒë·ªô):</span>
            <strong id="targetCaloriesValue">- kcal</strong>
          </div>
          <div class="result-item small">
            <span>BMI:</span>
            <strong id="bmiValue">-</strong>
          </div>
          <div class="result-item small">
            <span>Ch·∫ø ƒë·ªô:</span>
            <strong id="trainingModeLabel">-</strong>
          </div>
        </div>
      </div>
    </section>

    <!-- Kh·ªëi 2: M·ª•c ti√™u macro -->
    <section class="card" id="macroCard">
      <h2>
        <span>2. M·ª•c ti√™u macro trong ng√†y</span>
        <button class="btn btn-outline small collapse-btn" data-target-id="macroContent"><span class="arrow-icon"></span></button>
      </h2>
      <div id="macroContent" class="collapsible-content">
        <div class="macro-settings">
          <div class="form-group">
            <label for="proteinPerKg">Protein (g/kg c√¢n n·∫∑ng)</label>
            <input type="number" id="proteinPerKg" min="0.8" max="3" step="0.1" value="2" />
          </div>
          <div class="form-group">
            <label for="fatPerKg">Fat (g/kg c√¢n n·∫∑ng)</label>
            <input type="number" id="fatPerKg" min="0.5" max="1.5" step="0.1" value="0.8" />
          </div>
          <button id="applyMacroBtn" class="btn secondary small">T√≠nh macro t·ª´ g/kg</button>
        </div>

        <div class="macro-targets">
          <div class="macro-target">
            <div class="macro-header">
              <span>Calo</span>
              <span id="caloriesSummary">0 / 0 kcal</span>
            </div>
            <div class="progress-bar">
              <div id="caloriesProgress" class="progress-inner"></div>
            </div>
          </div>
          <div class="macro-target">
            <div class="macro-header">
              <span>Protein</span>
              <span id="proteinSummary">0 / 0 g</span>
            </div>
            <div class="progress-bar">
              <div id="proteinProgress" class="progress-inner protein"></div>
            </div>
          </div>
          <div class="macro-target">
            <div class="macro-header">
              <span>Carb</span>
              <span id="carbSummary">0 / 0 g</span>
            </div>
            <div class="progress-bar">
              <div id="carbProgress" class="progress-inner carb"></div>
            </div>
          </div>
          <div class="macro-target">
            <div class="macro-header">
              <span>Fat</span>
              <span id="fatSummary">0 / 0 g</span>
            </div>
            <div class="progress-bar">
              <div id="fatProgress" class="progress-inner fat"></div>
            </div>
          </div>
        </div>

        <!-- New: Gemini Chatbot Section -->
        <div class="chatbot-box" style="margin-top: 20px;">
          <div class="chatbot-header">
            <span>Chatbot Dinh d∆∞·ª°ng (Gemini AI)</span>
            <div class="chatbot-header-actions">
              <button id="refreshChatBtn" class="btn btn-outline small icon-btn" title="L√†m m·ªõi chat">üóëÔ∏è</button>
              <button class="btn btn-outline small collapse-btn" data-target-id="geminiChatbotContent"><span class="arrow-icon"></span></button>
            </div>
          </div>
          <div id="geminiChatbotContent" class="collapsible-content">
            <div class="gemini-api-section">
              <div class="form-group">
                <label for="geminiApiKey">Gemini API Key</label>
                <input type="text" id="geminiApiKey" placeholder="D√°n API key c·ªßa b·∫°n v√†o ƒë√¢y" />
              </div>
              <button id="saveGeminiKeyBtn" class="btn secondary small">L∆∞u key</button>
              <span class="gemini-status" id="geminiStatus">Ch∆∞a c·∫•u h√¨nh</span>
              <p class="hint small">API key ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.</p>
            </div>

            <div id="chatMessages" class="chat-messages">
              <!-- Chat messages will be rendered here -->
              <div class="chat-message bot">
                <p>Ch√†o b·∫°n! T√¥i l√† tr·ª£ l√Ω dinh d∆∞·ª°ng c·ªßa b·∫°n. H√£y h·ªèi t√¥i v·ªÅ d·ªØ li·ªáu dinh d∆∞·ª°ng c·ªßa b·∫°n ho·∫∑c b·∫•t k·ª≥ c√¢u h·ªèi n√†o v·ªÅ s·ª©c kh·ªèe!</p>
              </div>
            </div>
            <div class="chat-input-group">
              <input type="text" id="chatInput" placeholder="H·ªèi t√¥i ƒëi·ªÅu g√¨ ƒë√≥..." />
              <button id="sendChatBtn" class="btn primary small">G·ª≠i</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Kh·ªëi 3: Ch·ªçn m√≥n ƒÉn & danh s√°ch ƒë√£ ƒÉn -->
    <section class="card" id="foodTrackerCard">
      <div class="food-tracker-column">
        <h2>
          <span>3. M√≥n ƒÉn trong ng√†y <span id="selectedDateDisplay" class="selected-date-display"></span></span>
          <button class="btn btn-outline small collapse-btn" data-target-id="foodTrackerContent"><span class="arrow-icon"></span></button>
        </h2>
        <div id="foodTrackerContent" class="collapsible-content">
          <!-- Kh·ªëi: K·∫øt n·ªëi API USDA -->
          <div class="usda-box">
            <div class="usda-header">
              <span>API m√≥n ƒÉn USDA (t√πy ch·ªçn)</span>
              <button class="btn btn-outline small collapse-btn" data-target-id="usdaContent"><span class="arrow-icon"></span></button>
            </div>
            <div id="usdaContent" class="collapsible-content">
              <span class="usda-status" id="usdaStatus">Ch∆∞a c·∫•u h√¨nh</span>
              <div class="usda-grid">
                <div class="form-group">
                  <label for="usdaApiKey">USDA API Key</label>
                  <input type="text" id="usdaApiKey" placeholder="D√°n API key c·ªßa b·∫°n v√†o ƒë√¢y" />
                </div>
                <button id="saveUsdaKeyBtn" class="btn secondary small">L∆∞u key</button>
              </div>

              <div class="usda-grid">
                <div class="form-group">
                  <label for="usdaSearch">T√¨m m√≥n (USDA)</label>
                  <input type="text" id="usdaSearch" placeholder="V√≠ d·ª•: banana, rice, chicken..." />
                </div>
                <button id="usdaSearchBtn" class="btn primary small">T√¨m ki·∫øm</button>
              </div>

              <div class="form-group">
                <label for="usdaResults">K·∫øt qu·∫£ t√¨m ki·∫øm</label>
                <select id="usdaResults">
                  <option value="">Ch∆∞a c√≥ k·∫øt qu·∫£</option>
                </select>
                <p class="hint">Ch·ªçn 1 m√≥n, sau ƒë√≥ b·∫•m "Th√™m v√†o danh s√°ch th·ª©c ƒÉn" ƒë·ªÉ th√™m v√†o menu s·∫µn c√≥ (100g).</p>
              </div>

              <button id="addUsdaFoodBtn" class="btn btn-outline small" disabled>Th√™m v√†o danh s√°ch th·ª©c ƒÉn</button>
              <p class="hint small">L∆∞u √Ω: API USDA tr·∫£ v·ªÅ d·ªØ li·ªáu theo 100g, gi√° tr·ªã ch·ªâ mang t√≠nh tham kh·∫£o.</p>
            </div>
          </div>

          <!-- Kh·ªëi: Th√™m m√≥n ƒÉn th·ªß c√¥ng -->
          <div class="manual-food-box">
            <div class="manual-food-header">
              <span>Th√™m m√≥n ƒÉn th·ªß c√¥ng</span>
              <button class="btn btn-outline small collapse-btn" data-target-id="manualFoodContent"><span class="arrow-icon"></span></button>
            </div>
            <div id="manualFoodContent" class="collapsible-content">
              <div class="form-grid">
                <div class="form-group">
                  <label for="manualFoodName">T√™n m√≥n</label>
                  <input type="text" id="manualFoodName" placeholder="V√≠ d·ª•: Ph·ªü g√†" />
                </div>
                <div class="form-group">
                  <label for="manualFoodBaseAmount">L∆∞·ª£ng c∆° b·∫£n (g)</label>
                  <input type="number" id="manualFoodBaseAmount" min="1" value="100" />
                </div>
                <div class="form-group">
                  <label for="manualFoodUnit">ƒê∆°n v·ªã</label>
                  <input type="text" id="manualFoodUnit" value="g" />
                </div>
                <div class="form-group">
                  <label for="manualFoodCalories">Calo (kcal)</label>
                  <input type="number" id="manualFoodCalories" min="0" value="0" />
                </div>
                <div class="form-group">
                  <label for="manualFoodProtein">Protein (g)</label>
                  <input type="number" id="manualFoodProtein" min="0" value="0" step="0.1" />
                </div>
                <div class="form-group">
                  <label for="manualFoodCarb">Carb (g)</label>
                  <input type="number" id="manualFoodCarb" min="0" value="0" step="0.1" />
                </div>
                <div class="form-group">
                  <label for="manualFoodFat">Fat (g)</label>
                  <input type="number" id="manualFoodFat" min="0" value="0" step="0.1" />
                </div>
                <div class="form-actions">
                  <button id="addManualFoodBtn" class="btn secondary">Th√™m m√≥n th·ªß c√¥ng</button>
                </div>
              </div>
              <p class="hint small">L∆∞u √Ω: L∆∞·ª£ng c∆° b·∫£n v√† ƒë∆°n v·ªã s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t√≠nh to√°n khi b·∫°n ch·ªçn m√≥n n√†y.</p>
            </div>
          </div>


          <form id="foodForm" class="food-form">
            <div class="form-group">
              <label for="foodSelect">Ch·ªçn m√≥n</label>
              <select id="foodSelect">
              </select>
            </div>
            <div class="form-group">
              <label for="foodAmount">L∆∞·ª£ng ƒë√£ ƒÉn (gram)</label>
              <input type="number" id="foodAmount" min="1" step="1" value="100" />
              <p class="hint" id="foodBaseInfo">Th√¥ng tin m√≥n s·∫Ω hi·ªán t·∫°i ƒë√¢y</p>
            </div>
            <button type="submit" class="btn primary full">Th√™m v√†o ng√†y h√¥m nay</button>
          </form>

          <div class="food-summary">
            <h3>T·ªïng ƒë√£ ƒÉn h√¥m nay</h3>
            <div class="summary-grid">
              <div>
                <span>Calo</span>
                <strong id="totalCalories">0 kcal</strong>
              </div>
              <div>
                <span>Protein</span>
                <strong id="totalProtein">0 g</strong>
              </div>
              <div>
                <span>Carb</span>
                <strong id="totalCarb">0 g</strong>
              </div>
              <div>
                <span>Fat</span>
                <strong id="totalFat">0 g</strong>
              </div>
            </div>
          </div>

          <div class="food-list-header">
            <h3>Danh s√°ch m√≥n ƒë√£ ƒÉn</h3>
            <button id="resetDayBtn" class="btn btn-outline small">X√≥a ng√†y h√¥m nay</button>
          </div>
          <div class="table-wrapper">
            <table class="food-table">
              <thead>
              <tr>
                <th>M√≥n</th>
                <th>L∆∞·ª£ng (g)</th>
                <th>Calo</th>
                <th>P</th>
                <th>C</th>
                <th>F</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="foodTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Kh·ªëi L·ªãch (m·ª•c ri√™ng) -->
    <section class="card">
      <h2>L·ªãch s·ª≠ dinh d∆∞·ª°ng</h2>
      <div class="calendar-column">
        <div class="calendar-header">
          <button id="prevMonthBtn" class="btn btn-outline small">&lt;</button>
          <span id="currentMonthYear" class="current-month-year"></span>
          <button id="nextMonthBtn" class="btn btn-outline small">&gt;</button>
        </div>
        <div class="calendar-weekdays">
          <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span>CN</span>
        </div>
        <div id="calendarDaysGrid" class="calendar-days-grid">
          <!-- Days will be rendered here -->
        </div>
      </div>
    </section>

    <!-- Kh·ªëi 4: Bi·ªÉu ƒë·ªì dinh d∆∞·ª°ng h√†ng ng√†y -->
    <section class="card full-width">
      <h2>4. Bi·ªÉu ƒë·ªì dinh d∆∞·ª°ng h√†ng ng√†y</h2>
      <div class="daily-weight-input-section">
        <h3>Nh·∫≠p c√¢n n·∫∑ng h√†ng ng√†y</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="dailyWeightInput">C√¢n n·∫∑ng (kg)</label>
            <input type="number" id="dailyWeightInput" min="30" max="250" step="0.1" value="" placeholder="Nh·∫≠p c√¢n n·∫∑ng" />
          </div>
          <button id="saveDailyWeightBtn" class="btn primary small">L∆∞u c√¢n n·∫∑ng</button>
        </div>
        <p class="hint" id="currentDailyWeightDisplay">C√¢n n·∫∑ng h√¥m nay: - kg</p>
      </div>
      <div id="dailyChartContainer" class="daily-chart-container">
        <!-- Bi·ªÉu ƒë·ªì s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <p>Made for tracking TDEE &amp; calo h·∫±ng ng√†y (demo, kh√¥ng thay th·∫ø t∆∞ v·∫•n y t·∫ø).</p>
  </footer>

  <script src="script.js"></script>
</body>
</html>